FROM ubuntu:22.04

# attemp to avoid apt-get hash checksum issues
ENV DEBIAN_FRONTEND=noninteractive

# correctly addresses mac checksum issues
# error on Mac no matter the attempted changes. This 'magically' fixes it
# https://forums.docker.com/t/hash-sum-mismatch-writing-more-data-as-expected/45940/3
COPY ./badproxy /etc/apt/apt.conf.d/99fixbadproxy

WORKDIR /audb
COPY . /audb

# Install curl and gnupg (needed to add PostgreSQL repo)
RUN apt-get update && apt-get install -y \
    build-essential \
    clang \
    git \
    curl \
    lsb-release \
    # postgresql-common \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# # Add PostgreSQL official repo for version 16
# RUN curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc | gpg --dearmor -o /usr/share/keyrings/pgdg.gpg \
    # && echo "deb [signed-by=/usr/share/keyrings/pgdg.gpg] http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" \
#        > /etc/apt/sources.list.d/pgdg.list

RUN curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc | gpg --dearmor -o /usr/share/keyrings/pgdg.gpg \
    && echo "deb [signed-by=/usr/share/keyrings/pgdg.gpg] http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" \
    > /etc/apt/sources.list.d/pgdg.list

# # Install PostgreSQL 16
RUN apt-get update && apt-get install -y \
    postgresql-16 \
    postgresql-client-16 \
    && rm -rf /var/lib/apt/lists/*

# Optional: switch to bash
CMD ["bash"]